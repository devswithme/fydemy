- name: Deploy to VPS
  run: |
    ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
      # Step 1: Install Docker if missing
      if ! command -v docker &> /dev/null; then
        curl -fsSL https://get.docker.com -o get-docker.sh
        sudo sh get-docker.sh
        sudo usermod -aG docker $USER
      fi

      # Step 2: Install Docker Compose v2
      if ! docker compose version &> /dev/null; then
        DOCKER_CONFIG=${DOCKER_CONFIG:-$HOME/.docker}
        mkdir -p $DOCKER_CONFIG/cli-plugins
        curl -SL https://github.com/docker/compose/releases/download/v2.24.6/docker-compose-linux-x86_64 -o $DOCKER_CONFIG/cli-plugins/docker-compose
        chmod +x $DOCKER_CONFIG/cli-plugins/docker-compose
      fi

      # Step 3: Deploy project
      cd /home/${{ secrets.VPS_USER }}
      if [ ! -d "fydemy" ]; then
        git clone https://devswithme:${{ secrets.PAT_TOKEN }}@github.com/devswithme/fydemy.git
      fi

      cd fydemy
      echo "${{ secrets.ENV_FILE }}" > .env
      docker compose down
      docker compose up -d --build
    EOF
